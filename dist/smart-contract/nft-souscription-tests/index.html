<!DOCTYPE html>
<html lang="fr">
	<head>
    <meta charset="UTF-8">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Title -->
    <title>Gérer des souscriptions via des NFTs: les tests</title>
    <meta name="description" content="Suite du tutoriel expliquant comment gérer des souscriptions via l'aide de NFTs. Dans cette partie nous allons vérifier que notre smart contract fonctionne correctement avec des tests.">
    <link rel="stylesheet" href="/css/style.css">

    <!-- Responsive Stylesheet -->
    <link rel="stylesheet" href="/css/responsive.css">
    <link rel="sitemap" href="/sitemap-index.xml">
    <!-- Favicon -->
    <link rel="icon" href="/img/core-img/favicon.ico">
    <link rel="canonical" href="https://www.developpement-web3.fr/smart-contract/nft-souscription/">
 
 <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XNLXBTQEWJ"></script>

  
<script type="module" src="/_astro/hoisted.2ede0f3b.js"></script></head>
	<body>
		 
	   
    
        <!-- ##### Header Area Start ##### -->
    <nav class="navbar navbar-expand-lg navbar-white fixed-top" id="banner">
        <div class="container">
            <!-- Brand -->
            <a class="navbar-brand" href="/">Accueil</a>

            <!-- Toggler/collapsibe Button -->
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
                <span class="navbar-toggler-icon"></span>
            </button>

            <!-- Navbar links -->
            <div class="collapse navbar-collapse" id="collapsibleNavbar">

            </div>
        </div>
    </nav>
    <!-- ##### Header Area End ##### -->

    <!-- ##### Welcome Area Start ##### -->
    <div class="breadcumb-area">

        <!-- breadcumb content -->
        <div class="breadcumb-content">
            <div class="container h-100">
                <div class="row h-100 align-items-center">
                    <div class="col-12">
                        <nav aria-label="breadcrumb" class="breadcumb--con text-center">
                            <h2 class="w-text title wow fadeInUp" data-wow-delay="0.2s">Tests des souscriptions via NFT</h2>
                            <ol class="breadcrumb justify-content-center wow fadeInUp" data-wow-delay="0.4s">
                                <li class="breadcrumb-item"><a href="/">Accueil</a></li>
                                <li class="breadcrumb-item"><a href="/smart-contract-avec-solidity/">Smart
                                        contract</a></li>

                            </ol>
                        </nav>
                    </div>
                    <div class="col-12">
                        <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="csurbier" data-color="#5F7FFF" data-emoji="" data-font="Cookie" data-text="Buy me a coffee" data-outline-color="#000000" data-font-color="#ffffff" data-coffee-color="#FFDD00"></script>
                          <a href="https://www.buymeacryptobeer.com/ChristopheSurbier" target="_blank"><img src="https://www.buymeacryptobeer.com/assets/images/logo/bigLogo.png" style="padding-top:10px;border-radius: 10px; height: 57px !important;width: 150px !important;" alt=""></a>
                      </div>
                      <div class="col-12">
                        <a style="color:white!important;font-size: 14px;" href="mailto:csurbier@idevotion.fr" target="_blank">M'écrire, me signaler une erreur?</a>
                      </div>
                      <div>

<!-- AddToAny BEGIN -->
<div class="a2a_kit a2a_kit_size_32 a2a_default_style">
    <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_email"></a>
    <a class="a2a_button_linkedin"></a>
    </div>
    
    <script async src="https://static.addtoany.com/menu/page.js"></script>
    <!-- AddToAny END -->
                      </div>
                </div>
            </div>
        </div>
    </div>
      <!-- ##### Blog Area Start ##### -->
      <section class="blog-area section-padding-100-85">
        <div class="container">

            <div class="row">
                
                <div class="col-12">
                    <div class="single-blog-area wow fadeInUp" data-wow-delay="0.2s">
                        <!-- Post Thumbnail -->
                        <div class="blog_thumbnail">
                            
                        </div>

                        <div class="blog-content">
                            <h2 id="tests-du-smart-contract-gérant-les-souscriptions-par-nft">Tests du smart contract gérant les souscriptions par NFT</h2>
<p>Tout d’abord écrivons la fonction qui sera redéployée avant chaque test et permettant d’initialiser notre smart contract :</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> { loadFixture } </span><span style="color: #FF7B72">from</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"@nomicfoundation/hardhat-network-helpers"</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> { expect } </span><span style="color: #FF7B72">from</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"chai"</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> { ethers } </span><span style="color: #FF7B72">from</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"hardhat"</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #FF7B72">import</span><span style="color: #C9D1D9"> { time } </span><span style="color: #FF7B72">from</span><span style="color: #C9D1D9"> </span><span style="color: #A5D6FF">"@nomicfoundation/hardhat-network-helpers"</span><span style="color: #C9D1D9">;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D2A8FF">describe</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"NftSubscriptionContract"</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> () {</span></span>
<span class="line"><span style="color: #C9D1D9">  </span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">deployFixture</span><span style="color: #C9D1D9">() {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// Contracts are deployed using the first signer/account by default</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">owner</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">account1</span><span style="color: #C9D1D9">,</span><span style="color: #79C0FF">account2</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> ethers.</span><span style="color: #D2A8FF">getSigners</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">NftSubscriptionContract</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> ethers.</span><span style="color: #D2A8FF">getContractFactory</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"NftSubscriptionContract"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">nftContract</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> NftSubscriptionContract.</span><span style="color: #D2A8FF">deploy</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">return</span><span style="color: #C9D1D9"> { nftContract};</span></span>
<span class="line"><span style="color: #C9D1D9">  }</span></span></code></pre>
<p>Maintenant passons aux choses sérieuses. Tout d’abord nous allons tester une souscription annuelle et nous balader dans le temps pour vérifier l’état de la souscription:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #D2A8FF">describe</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Souscription"</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> () {</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">it</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Souscription annuelle"</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> () {</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">owner</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">account1</span><span style="color: #C9D1D9">,</span><span style="color: #79C0FF">account2</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> ethers.</span><span style="color: #D2A8FF">getSigners</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> { </span><span style="color: #79C0FF">nftContract</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">loadFixture</span><span style="color: #C9D1D9">(deployFixture);</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> price </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">  ethers.utils.</span><span style="color: #D2A8FF">parseEther</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"99"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">      </span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #8B949E">//Subscribe to a yearly membership</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account1)</span></span>
<span class="line"><span style="color: #C9D1D9">      .</span><span style="color: #D2A8FF">mintCard</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">,{value: price}))</span></span>
<span class="line"><span style="color: #C9D1D9">      .to.</span><span style="color: #D2A8FF">emit</span><span style="color: #C9D1D9">(nftContract,</span><span style="color: #A5D6FF">'NewMemberCard'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">      .</span><span style="color: #D2A8FF">withArgs</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">        account1.address,</span></span>
<span class="line"><span style="color: #C9D1D9">        price)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #8B949E">// get the memberCard of the organizer using the members variable</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> memberCardId </span><span style="color: #FF7B72">=</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> memberCard </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> nftContract.</span><span style="color: #D2A8FF">members</span><span style="color: #C9D1D9">(memberCardId);</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #8B949E">// Should be a Yearly member card</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(memberCard.cardType).to.be.</span><span style="color: #D2A8FF">eq</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(memberCard.paid).to.</span><span style="color: #D2A8FF">eq</span><span style="color: #C9D1D9">(price)</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(memberCard.valid).to.</span><span style="color: #D2A8FF">eq</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #8B949E">//check expiration date </span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> timeStamp </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> ethers.provider.</span><span style="color: #D2A8FF">getBlock</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"latest"</span><span style="color: #C9D1D9">)).timestamp</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #8B949E">// expiration date should be greater than 11 months in future</span></span>
<span class="line"><span style="color: #C9D1D9">     timeStamp</span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">11</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">31</span><span style="color: #FF7B72">*</span><span style="color: #79C0FF">86400</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(memberCard.expDte).to.be.</span><span style="color: #D2A8FF">greaterThan</span><span style="color: #C9D1D9">(timeStamp)</span></span>
<span class="line"><span style="color: #C9D1D9">     </span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #8B949E">// get the memberCard  using the getMemberCard function</span></span>
<span class="line"><span style="color: #C9D1D9">     memberCard </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account1).</span><span style="color: #D2A8FF">getMemberCard</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #8B949E">// Should be a Yearly member card</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(memberCard.cardType).to.be.</span><span style="color: #D2A8FF">eq</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(memberCard.paid).to.</span><span style="color: #D2A8FF">eq</span><span style="color: #C9D1D9">(price)</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(memberCard.valid).to.</span><span style="color: #D2A8FF">eq</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">     timeStamp </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> ethers.provider.</span><span style="color: #D2A8FF">getBlock</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"latest"</span><span style="color: #C9D1D9">)).timestamp</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #8B949E">// expiration date should be greater than 11 months in future</span></span>
<span class="line"><span style="color: #C9D1D9">     timeStamp</span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">11</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">31</span><span style="color: #FF7B72">*</span><span style="color: #79C0FF">86400</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(memberCard.expDte).to.be.</span><span style="color: #D2A8FF">greaterThan</span><span style="color: #C9D1D9">(timeStamp)</span></span>
<span class="line"><span style="color: #C9D1D9">    });</span></span>
<span class="line"><span style="color: #C9D1D9">});    </span></span></code></pre>
<p>Après avoir crée la souscription, nous utilisation la variable publique <strong>members</strong> pour vérifier que la carte de membre associé au NFT d’identifiant 0 existe bien, est valide et la date d’expiration est supérieur à 11 mois.</p>
<p>Ensuite on utilise la méthode <strong>getMemberCard</strong> à partir du compte auquel appartient le NFT pour vérifier la même chose.</p>
<p>Pour le prochain test, nous allons prendre un abonnement mensuel, puis aller dans le futur (après 1 mois) et vérifier que l’abonnement est caduque tandis que 10 jours après l’abonnement, celui ci est toujours valide:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9">  </span><span style="color: #D2A8FF">it</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Souscription mensuelle et check expire apres 1 mois"</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> () {</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">owner</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">account1</span><span style="color: #C9D1D9">,</span><span style="color: #79C0FF">account2</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> ethers.</span><span style="color: #D2A8FF">getSigners</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> { </span><span style="color: #79C0FF">nftContract</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">loadFixture</span><span style="color: #C9D1D9">(deployFixture);</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> price </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">  ethers.utils.</span><span style="color: #D2A8FF">parseEther</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"10"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #8B949E">//We need to set our nftTicket smart contract owner of the factory </span></span>
<span class="line"><span style="color: #C9D1D9">    </span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account1)</span></span>
<span class="line"><span style="color: #C9D1D9">      .</span><span style="color: #D2A8FF">mintCard</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">,{value: price}))</span></span>
<span class="line"><span style="color: #C9D1D9">      .to.</span><span style="color: #D2A8FF">emit</span><span style="color: #C9D1D9">(nftContract,</span><span style="color: #A5D6FF">'NewMemberCard'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">      .</span><span style="color: #D2A8FF">withArgs</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">        account1.address,</span></span>
<span class="line"><span style="color: #C9D1D9">        price)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// get the memberCard of the organizer using the getMemberCard function</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> memberCard </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account1).</span><span style="color: #D2A8FF">getMemberCard</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #8B949E">// Should be a Monthly member card</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(memberCard.cardType).to.be.</span><span style="color: #D2A8FF">eq</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(memberCard.valid).to.</span><span style="color: #D2A8FF">eq</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> timeStamp </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> ethers.provider.</span><span style="color: #D2A8FF">getBlock</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"latest"</span><span style="color: #C9D1D9">)).timestamp</span></span>
<span class="line"><span style="color: #C9D1D9">   </span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #8B949E">// let's go 10 days   in the future</span></span>
<span class="line"><span style="color: #C9D1D9">    timeStamp</span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">10</span><span style="color: #FF7B72">*</span><span style="color: #79C0FF">86400</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> time.</span><span style="color: #D2A8FF">increaseTo</span><span style="color: #C9D1D9">(timeStamp);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// get member card again and check still true</span></span>
<span class="line"><span style="color: #C9D1D9">    memberCard </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account1).</span><span style="color: #D2A8FF">getMemberCard</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(memberCard.valid).to.</span><span style="color: #D2A8FF">eq</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">   </span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// let's go 1 month and 1 day in the future</span></span>
<span class="line"><span style="color: #C9D1D9">    timeStamp</span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">32</span><span style="color: #FF7B72">*</span><span style="color: #79C0FF">86400</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> time.</span><span style="color: #D2A8FF">increaseTo</span><span style="color: #C9D1D9">(timeStamp);</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #8B949E">// get member card again </span></span>
<span class="line"><span style="color: #C9D1D9">    memberCard </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account1).</span><span style="color: #D2A8FF">getMemberCard</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(memberCard.valid).to.</span><span style="color: #D2A8FF">eq</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">false</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">   });</span></span></code></pre>
<p>Maintenant vérifions pour un compte n’ayant pas souscris d’abonnement (donc miné de NFT), n’est pas membre:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">it</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Check souscription inexistante"</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> () {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">owner</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">account1</span><span style="color: #C9D1D9">,</span><span style="color: #79C0FF">account2</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> ethers.</span><span style="color: #D2A8FF">getSigners</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> { </span><span style="color: #79C0FF">nftContract</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">loadFixture</span><span style="color: #C9D1D9">(deployFixture);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #8B949E">// get the memberCard of the organizer using the getMemberCard function</span></span>
<span class="line"><span style="color: #C9D1D9">       </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> memberCard </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account2).</span><span style="color: #D2A8FF">getMemberCard</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">     </span></span>
<span class="line"><span style="color: #C9D1D9">       </span><span style="color: #8B949E">// Should be a Monthly member card</span></span>
<span class="line"><span style="color: #C9D1D9">       </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(memberCard.valid).to.</span><span style="color: #D2A8FF">eq</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">false</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    });</span></span></code></pre>
<p>Vérifions qu’il n’est pas possible pour un compte de prendre plusieurs cartes de membres:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">it</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Pas plus d'une souscription pour un utilisateur"</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> () {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">owner</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">account1</span><span style="color: #C9D1D9">,</span><span style="color: #79C0FF">account2</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> ethers.</span><span style="color: #D2A8FF">getSigners</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> { </span><span style="color: #79C0FF">nftContract</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">loadFixture</span><span style="color: #C9D1D9">(deployFixture);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> price </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">  ethers.utils.</span><span style="color: #D2A8FF">parseEther</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"10"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account1)</span></span>
<span class="line"><span style="color: #C9D1D9">          .</span><span style="color: #D2A8FF">mintCard</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">,{value: price}))</span></span>
<span class="line"><span style="color: #C9D1D9">          .to.</span><span style="color: #D2A8FF">emit</span><span style="color: #C9D1D9">(nftContract,</span><span style="color: #A5D6FF">'NewMemberCard'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">          .</span><span style="color: #D2A8FF">withArgs</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">              account1.address,</span></span>
<span class="line"><span style="color: #C9D1D9">              price)</span></span>
<span class="line"><span style="color: #C9D1D9">      </span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account1)</span></span>
<span class="line"><span style="color: #C9D1D9">           .</span><span style="color: #D2A8FF">mintCard</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">,{value: price})).to.</span><span style="color: #D2A8FF">revertedWith</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Already member please renew your subscription"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">      </span></span>
<span class="line"><span style="color: #C9D1D9">    });</span></span></code></pre>
<h1 id="test-du-renouvellement-dabonnement-par-nft">Test du renouvellement d’abonnement par NFT</h1>
<p>Essayons maintenant de renouveller un abonnement puis de se balader dans le futur pour voir l’état de celui ci:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">it</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Souscription mensuelle et renouvellement"</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> () {</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">owner</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">account1</span><span style="color: #C9D1D9">,</span><span style="color: #79C0FF">account2</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> ethers.</span><span style="color: #D2A8FF">getSigners</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> { </span><span style="color: #79C0FF">nftContract</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">loadFixture</span><span style="color: #C9D1D9">(deployFixture);</span></span>
<span class="line"><span style="color: #C9D1D9">      </span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> price </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">  ethers.utils.</span><span style="color: #D2A8FF">parseEther</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"10"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">      </span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account1)</span></span>
<span class="line"><span style="color: #C9D1D9">        .</span><span style="color: #D2A8FF">mintCard</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">,{value: price}))</span></span>
<span class="line"><span style="color: #C9D1D9">        .to.</span><span style="color: #D2A8FF">emit</span><span style="color: #C9D1D9">(nftContract,</span><span style="color: #A5D6FF">'NewMemberCard'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">        .</span><span style="color: #D2A8FF">withArgs</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">            account1.address,</span></span>
<span class="line"><span style="color: #C9D1D9">            price)</span></span>
<span class="line"><span style="color: #C9D1D9">    </span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #8B949E">// let's go 1 month and 1 day in the future</span></span>
<span class="line"><span style="color: #C9D1D9">        </span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> timeStamp </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> (</span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> ethers.provider.</span><span style="color: #D2A8FF">getBlock</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"latest"</span><span style="color: #C9D1D9">)).timestamp</span></span>
<span class="line"><span style="color: #C9D1D9">     timeStamp</span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">32</span><span style="color: #FF7B72">*</span><span style="color: #79C0FF">86400</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> time.</span><span style="color: #D2A8FF">increaseTo</span><span style="color: #C9D1D9">(timeStamp);</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #8B949E">// get member card again </span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> memberCard </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account1).</span><span style="color: #D2A8FF">getMemberCard</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(memberCard.valid).to.</span><span style="color: #D2A8FF">eq</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">false</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">     </span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #8B949E">// try to renew</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account1)</span></span>
<span class="line"><span style="color: #C9D1D9">        .</span><span style="color: #D2A8FF">renewSubscription</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">,{value: price}))</span></span>
<span class="line"><span style="color: #C9D1D9">        .to.</span><span style="color: #D2A8FF">emit</span><span style="color: #C9D1D9">(nftContract,</span><span style="color: #A5D6FF">'MemberCardRenewed'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">     </span></span>
<span class="line"><span style="color: #C9D1D9">    memberCard </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account1).</span><span style="color: #D2A8FF">getMemberCard</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(memberCard.valid).to.</span><span style="color: #D2A8FF">eq</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #8B949E">// check 4 days later</span></span>
<span class="line"><span style="color: #C9D1D9">     timeStamp</span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">4</span><span style="color: #FF7B72">*</span><span style="color: #79C0FF">86400</span><span style="color: #C9D1D9">;</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> time.</span><span style="color: #D2A8FF">increaseTo</span><span style="color: #C9D1D9">(timeStamp);</span></span>
<span class="line"><span style="color: #C9D1D9">     memberCard </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account1).</span><span style="color: #D2A8FF">getMemberCard</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(memberCard.valid).to.</span><span style="color: #D2A8FF">eq</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #8B949E">// check failed again 1 month and 1 day in the future</span></span>
<span class="line"><span style="color: #C9D1D9">     timeStamp</span><span style="color: #FF7B72">+=</span><span style="color: #C9D1D9"> </span><span style="color: #79C0FF">1</span><span style="color: #FF7B72">*</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">32</span><span style="color: #FF7B72">*</span><span style="color: #79C0FF">86400</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> time.</span><span style="color: #D2A8FF">increaseTo</span><span style="color: #C9D1D9">(timeStamp);</span></span>
<span class="line"><span style="color: #C9D1D9">     memberCard </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account1).</span><span style="color: #D2A8FF">getMemberCard</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">     </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(memberCard.valid).to.</span><span style="color: #D2A8FF">eq</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">false</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">    });</span></span></code></pre>
<p>Les deux prochains tests concernent les vérifications sur le paiement:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">it</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Souscription paiement KO"</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> () {</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">owner</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">account1</span><span style="color: #C9D1D9">,</span><span style="color: #79C0FF">account2</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> ethers.</span><span style="color: #D2A8FF">getSigners</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> { </span><span style="color: #79C0FF">nftContract</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">loadFixture</span><span style="color: #C9D1D9">(deployFixture);</span></span>
<span class="line"><span style="color: #C9D1D9">      </span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> price </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">  ethers.utils.</span><span style="color: #D2A8FF">parseEther</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"8"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">      </span></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account1)</span></span>
<span class="line"><span style="color: #C9D1D9">        .</span><span style="color: #D2A8FF">mintCard</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">,{value: price})).to.</span><span style="color: #D2A8FF">revertedWith</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Payment value incorrect"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">      </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account1)</span></span>
<span class="line"><span style="color: #C9D1D9">        .</span><span style="color: #D2A8FF">mintCard</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">1</span><span style="color: #C9D1D9">,{value: price})).to.</span><span style="color: #D2A8FF">revertedWith</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Payment value incorrect"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">      </span></span>
<span class="line"><span style="color: #C9D1D9">    });</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">    </span><span style="color: #D2A8FF">it</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Souscription changement de prix"</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> () {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">owner</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">account1</span><span style="color: #C9D1D9">,</span><span style="color: #79C0FF">account2</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> ethers.</span><span style="color: #D2A8FF">getSigners</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> { </span><span style="color: #79C0FF">nftContract</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">loadFixture</span><span style="color: #C9D1D9">(deployFixture);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> price </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">  ethers.utils.</span><span style="color: #D2A8FF">parseEther</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"10"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account1)</span></span>
<span class="line"><span style="color: #C9D1D9">          .</span><span style="color: #D2A8FF">mintCard</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">,{value: price}))</span></span>
<span class="line"><span style="color: #C9D1D9">          .to.</span><span style="color: #D2A8FF">emit</span><span style="color: #C9D1D9">(nftContract,</span><span style="color: #A5D6FF">'NewMemberCard'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">          .</span><span style="color: #D2A8FF">withArgs</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">              account1.address,</span></span>
<span class="line"><span style="color: #C9D1D9">              price)</span></span>
<span class="line"><span style="color: #C9D1D9">  </span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> newPrice </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">  ethers.utils.</span><span style="color: #D2A8FF">parseEther</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"4"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> nftContract.</span><span style="color: #D2A8FF">changePrice</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">,newPrice);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account2)</span></span>
<span class="line"><span style="color: #C9D1D9">        .</span><span style="color: #D2A8FF">mintCard</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">,{value: price})).to.</span><span style="color: #D2A8FF">revertedWith</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Payment value incorrect"</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(owner)</span></span>
<span class="line"><span style="color: #C9D1D9">            .</span><span style="color: #D2A8FF">mintCard</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">,{value: newPrice})) </span></span>
<span class="line"><span style="color: #C9D1D9">            .to.</span><span style="color: #D2A8FF">emit</span><span style="color: #C9D1D9">(nftContract,</span><span style="color: #A5D6FF">'NewMemberCard'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">            .</span><span style="color: #D2A8FF">withArgs</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">                owner.address,</span></span>
<span class="line"><span style="color: #C9D1D9">                newPrice)</span></span>
<span class="line"><span style="color: #C9D1D9">      });</span></span></code></pre>
<p>Et pour conclure nous allons vérifier que le transfert d’un NFT, transfére aussi la carte de membre:</p>
<pre is:raw="" class="astro-code" style="background-color: #0d1117; overflow-x: auto;"><code><span class="line"><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">it</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"Transfert d'un NFT/abonnement "</span><span style="color: #C9D1D9">, </span><span style="color: #FF7B72">async</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">function</span><span style="color: #C9D1D9"> () {</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> [</span><span style="color: #79C0FF">owner</span><span style="color: #C9D1D9">, </span><span style="color: #79C0FF">account1</span><span style="color: #C9D1D9">,</span><span style="color: #79C0FF">account2</span><span style="color: #C9D1D9">] </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> ethers.</span><span style="color: #D2A8FF">getSigners</span><span style="color: #C9D1D9">();</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">const</span><span style="color: #C9D1D9"> { </span><span style="color: #79C0FF">nftContract</span><span style="color: #C9D1D9"> } </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">loadFixture</span><span style="color: #C9D1D9">(deployFixture);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> price </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9">  ethers.utils.</span><span style="color: #D2A8FF">parseEther</span><span style="color: #C9D1D9">(</span><span style="color: #A5D6FF">"10"</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account1)</span></span>
<span class="line"><span style="color: #C9D1D9">          .</span><span style="color: #D2A8FF">mintCard</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">,{value: price}))</span></span>
<span class="line"><span style="color: #C9D1D9">          .to.</span><span style="color: #D2A8FF">emit</span><span style="color: #C9D1D9">(nftContract,</span><span style="color: #A5D6FF">'NewMemberCard'</span><span style="color: #C9D1D9">)</span></span>
<span class="line"><span style="color: #C9D1D9">          .</span><span style="color: #D2A8FF">withArgs</span><span style="color: #C9D1D9">(</span></span>
<span class="line"><span style="color: #C9D1D9">              account1.address,</span></span>
<span class="line"><span style="color: #C9D1D9">              price)</span></span>
<span class="line"><span style="color: #C9D1D9">        </span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> memberCardAccount1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account1).</span><span style="color: #D2A8FF">getMemberCard</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(memberCardAccount1.valid).to.</span><span style="color: #D2A8FF">eq</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">     </span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #8B949E">// Transfert NFT to account2</span></span>
<span class="line"><span style="color: #C9D1D9">        nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account1).</span><span style="color: #D2A8FF">transferFrom</span><span style="color: #C9D1D9">(account1.address, account2.address, </span><span style="color: #79C0FF">0</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">        </span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #8B949E">// Check account1 is not a member</span></span>
<span class="line"><span style="color: #C9D1D9">        memberCardAccount1 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account1).</span><span style="color: #D2A8FF">getMemberCard</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(memberCardAccount1.valid).to.</span><span style="color: #D2A8FF">eq</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">false</span><span style="color: #C9D1D9">);</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #8B949E">// Check account2 is a member </span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #FF7B72">let</span><span style="color: #C9D1D9"> memberCardAccount2 </span><span style="color: #FF7B72">=</span><span style="color: #C9D1D9"> </span><span style="color: #FF7B72">await</span><span style="color: #C9D1D9"> nftContract.</span><span style="color: #D2A8FF">connect</span><span style="color: #C9D1D9">(account2).</span><span style="color: #D2A8FF">getMemberCard</span><span style="color: #C9D1D9">()</span></span>
<span class="line"><span style="color: #C9D1D9">        </span><span style="color: #D2A8FF">expect</span><span style="color: #C9D1D9">(memberCardAccount2.valid).to.</span><span style="color: #D2A8FF">eq</span><span style="color: #C9D1D9">(</span><span style="color: #79C0FF">true</span><span style="color: #C9D1D9">);</span></span>
<span class="line"><span style="color: #C9D1D9">            </span></span>
<span class="line"><span style="color: #C9D1D9">        </span></span>
<span class="line"><span style="color: #C9D1D9">      });</span></span></code></pre>
<p>Et voilà.</p>
<p>J’espère que ce tutoriel vous a plu. Pour rappel, vous pouvez trouver le code source de cet article sur mon GitHub.</p>
<p>Vous pouvez aussi soutenir ce site en envoyant de l’ETH ou du MATIC:</p>
<img style="width: 100px;" src="/img/qr-code.png">
<style>
    p { color: white;!important }
    a { color:darkorange!important}
  </style>
                         
                        </div>
                    </div>

                </div>


            </div>
        </div>
    </section>
    <!-- ##### Blog Area End ##### -->
		<footer class="footer-area bg-img" style="background-image: url(img/core-img/pattern.png);"> 
    <div class="footer-content-area "> 
        <div class="container"> 
            <div class="row">
              </div>
            <div class="row "> 
             
                <div class="col-12 col-lg-4 col-md-6"> 
                    <div class="footer-copywrite-info"> 
                        <!-- Copywrite -->                                 
                        <div class="copywrite_text fadeInUp" data-wow-delay="0.2s"> 
                            <div class="footer-logo"> 
                                
                            </div>    
                                                           
                            <p>Vous pouvez me retrouver sur :</p> 
                        </div>                                 
                        <!-- Social Icon -->                                 
                        <div class="footer-social-info fadeInUp" data-wow-delay="0.4s"> 
                           
                            <a href="https://twitter.com/csurbier"> <i class="fa fa-twitter" aria-hidden="true"></i></a> 
                            <a href="https://github.com/csurbier"><i class="fa fa-github" aria-hidden="true"></i></a> 
                            <a href="https://www.malt.fr/profile/christophesurbier"><i class="fa fa-slack" aria-hidden="true"></i></a> 
                            <a href="https://www.linkedin.com/in/christophesurbier/"><i class="fa fa-linkedin" aria-hidden="true"></i></a> 
                        </div>                                 
                    </div>                             
                </div>                         
                <div class="col-12 col-lg-3 col-md-6"> 
                    <div class="contact_info_area d-sm-flex justify-content-between"> 
                        <!-- Content Info -->                                 
                        <div class="contact_info mt-x text-center fadeInUp" data-wow-delay="0.3s"> 
                            
                        </div>                                 
                    </div>                             
                </div>                         
                <div class="col-12 col-lg-2 col-md-6 "> 
                    <!-- Content Info -->                             
                    <div class="contact_info_area d-sm-flex justify-content-between"> 
                        <div class="contact_info mt-s text-center fadeInUp" data-wow-delay="0.2s"> 
                           
                        </div>                                 
                    </div>                             
                </div>                         
                <div class="col-12 col-lg-3 col-md-6 "> 
                    <div class="contact_info_area d-sm-flex justify-content-between"> 
                        <!-- Content Info -->                                 
                        <div class="contact_info mt-s text-center fadeInUp" data-wow-delay="0.4s"> 
                            
                        </div>                                 
                    </div>                             
                </div>    
                <div class="col-12" style="font-size: 14px;">
                    Copyright © 2023. Created with ❤️ in Barcelona. Build proudly with <a style="color:white" href="https://astro.build/" target="_blank"><img style="width:20px" src="https://astro.build/favicon.svg" alt="Astro">Astro</a>
                </div>                     
            </div>                     
        </div>                 
    </div>             
</footer>     
          
<script src="/js/jquery.min.js"></script>
<script src="/js/popper.min.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/plugins.js"></script>
<script src="/js/script.js"></script>
	</body></html>